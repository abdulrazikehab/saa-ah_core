generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
 shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model Tenant {
  id                 String              @id @default(cuid())
  name               String
  subdomain          String              @unique
  plan               PlanType            @default(STARTER)
  status             Status              @default(ACTIVE)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  settings           Json?
  description        String?
  templateId         String?
  carts              Cart[]
  categories         Category[]
  coupons            Coupon[]
  customDomains      CustomDomain[]
  orders             Order[]
  pages              Page[]
  paymentMethods     PaymentMethod[]
  plugins            Plugin[]
  productCollections ProductCollection[]
  productTags        ProductTag[]
  products           Product[]
  shippingZones      ShippingZone[]
  siteConfig         SiteConfig?
  sslCertificates    SSLCertificate[]
  taxRates           TaxRate[]
  themes             Theme[]
  users              User[]
  webhookEndpoints   WebhookEndpoint[]
  transactions       Transaction[]
  activityLogs       ActivityLog[]       @relation("ActivityLogs")
  chatMessages       ChatMessage[]       @relation("ChatMessages")
  featureFlags       FeatureFlag[]
  integrations       Integration[]
  userGifts          UserGift[]
  securityEvents     SecurityEvent[]
  suppliers          Supplier[]
  brands             Brand[]
  currencies         Currency[]
  currencySettings   CurrencySettings?
  units              Unit[]
  // Digital Cards Marketplace
  cardProducts       CardProduct[]
  cardInventory      CardInventory[]
  cardOrders         CardOrder[]
  wallets            Wallet[]
  topUpRequests      WalletTopUpRequest[]
  banks              Bank[]
  supportTickets     SupportTicket[]
  cardBatches        CardBatch[]
  // Merchant Dealer App
  merchants          Merchant[]
  promotions         Promotion[]
  apiKeys            ApiKey[]

  @@map("tenants")
}

model Product {
  id              String                  @id @default(cuid())
  tenantId        String
  productId       String? // Optional product ID
  productCode     String? // External supplier product code
  name            String
  description     String?
  sku             String?                 @unique
  price           Decimal
  compareAtPrice  Decimal?
  costPerItem     Decimal?
  isAvailable     Boolean                 @default(true)
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  isPublished     Boolean                 @default(true)
  seoDescription  String?
  seoTitle        String?
  nameAr          String?
  descriptionAr   String?
  barcode         String?
  featured        Boolean                 @default(false)
  weight          Decimal?
  dimensions      String?
  brandId         String? // Brand reference
  odooProductId   String? // Odoo integration ID
  cartItems       CartItem[]
  orderItems      OrderItem[]
  categories      ProductCategory[]
  collectionItems ProductCollectionItem[]
  images          ProductImage[]
  tagItems        ProductTagItem[]
  variants        ProductVariant[]
  suppliers       ProductSupplier[]
  supplierPurchases SupplierPurchase[]
  brand           Brand?                  @relation(fields: [brandId], references: [id])
  unitId          String? // Unit reference
  unit            Unit?                   @relation(fields: [unitId], references: [id])
  tenant          Tenant                  @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([isAvailable, isPublished])
  @@index([createdAt])
  @@index([brandId])
  @@index([tenantId, productCode])
  @@index([unitId])
  @@map("products")
}

model ProductVariant {
  id                String      @id @default(cuid())
  productId         String
  name              String
  sku               String?     @unique
  price             Decimal
  compareAtPrice    Decimal?
  inventoryQuantity Int         @default(0)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  trackInventory    Boolean     @default(true)
  weight            Decimal?
  cartItems         CartItem[]
  orderItems        OrderItem[]
  product           Product     @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

model Category {
  id           String            @id @default(cuid())
  tenantId     String
  name         String
  nameAr       String?           // Arabic name
  description  String?
  descriptionAr String?          // Arabic description
  slug         String
  icon         String?           // Category icon (emoji or icon name)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  image        String?
  isActive     Boolean           @default(true)
  parentId     String?
  sortOrder    Int               @default(0) // Display order
  tenant       Tenant            @relation(fields: [tenantId], references: [id])
  products     ProductCategory[]
  cardProducts CardProduct[]     @relation("CardProductCategory")
  parent       Category?         @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children     Category[]        @relation("CategoryHierarchy")

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([isActive])
  @@index([parentId])
  @@map("categories")
}

model ProductCategory {
  id         String   @id @default(cuid())
  productId  String
  categoryId String
  sortOrder  Int      @default(0)
  category   Category @relation(fields: [categoryId], references: [id])
  product    Product  @relation(fields: [productId], references: [id])

  @@unique([productId, categoryId])
  @@map("product_categories")
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  url       String
  altText   String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id])

  @@index([productId])
  @@map("product_images")
}

model ProductCollection {
  id          String                  @id @default(cuid())
  tenantId    String
  name        String
  description String?
  slug        String
  image       String?
  isActive    Boolean                 @default(true)
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  products    ProductCollectionItem[]
  tenant      Tenant                  @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@map("product_collections")
}

model ProductCollectionItem {
  id           String            @id @default(cuid())
  collectionId String
  productId    String
  sortOrder    Int               @default(0)
  collection   ProductCollection @relation(fields: [collectionId], references: [id])
  product      Product           @relation(fields: [productId], references: [id])

  @@unique([collectionId, productId])
  @@map("product_collection_items")
}

model ProductTag {
  id        String           @id @default(cuid())
  tenantId  String
  name      String
  slug      String
  createdAt DateTime         @default(now())
  products  ProductTagItem[]
  tenant    Tenant           @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, slug])
  @@map("product_tags")
}

model ProductTagItem {
  id        String     @id @default(cuid())
  productId String
  tagId     String
  product   Product    @relation(fields: [productId], references: [id])
  tag       ProductTag @relation(fields: [tagId], references: [id])

  @@unique([productId, tagId])
  @@map("product_tag_items")
}

model Cart {
  id         String     @id @default(cuid())
  tenantId   String
  sessionId  String?
  userId     String?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  couponCode String?
  cartItems  CartItem[]
  tenant     Tenant     @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([sessionId])
  @@index([userId])
  @@map("carts")
}

model CartItem {
  id               String          @id @default(cuid())
  cartId           String
  productId        String
  productVariantId String?
  quantity         Int             @default(1)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  cart             Cart            @relation(fields: [cartId], references: [id])
  product          Product         @relation(fields: [productId], references: [id])
  productVariant   ProductVariant? @relation(fields: [productVariantId], references: [id])

  @@unique([cartId, productId, productVariantId])
  @@index([cartId])
  @@map("cart_items")
}

model Order {
  id                String             @id @default(cuid())
  tenantId          String
  orderNumber       String             @unique
  customerEmail     String
  totalAmount       Decimal
  status            OrderStatus        @default(PENDING)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  billingAddress    Json?
  customerName      String?
  shippingAddress   Json?
  cancelledAt       DateTime?
  customerPhone     String?
  deliveredAt       DateTime?
  discountAmount    Decimal            @default(0)
  paidAt            DateTime?
  paymentMethodId   String?
  paymentStatus     PaymentStatus      @default(PENDING)
  shippedAt         DateTime?
  shippingAmount    Decimal            @default(0)
  shippingMethodId  String?
  shippingStatus    ShippingStatus     @default(UNFULFILLED)
  subtotalAmount    Decimal
  taxAmount         Decimal            @default(0)
  trackingNumber    String?
  transactionId     String?
  ipAddress         String?
  couponRedemptions CouponRedemption[]
  orderItems        OrderItem[]
  paymentMethod     PaymentMethod?     @relation(fields: [paymentMethodId], references: [id])
  shippingMethod    ShippingMethod?    @relation(fields: [shippingMethodId], references: [id])
  tenant            Tenant             @relation(fields: [tenantId], references: [id])
  transactions      Transaction[]

  @@index([tenantId])
  @@index([customerEmail])
  @@index([status, paymentStatus])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id               String          @id @default(cuid())
  orderId          String
  productId        String
  productVariantId String?
  quantity         Int
  price            Decimal
  productName      String
  variantName      String?
  sku              String?
  order            Order           @relation(fields: [orderId], references: [id])
  product          Product         @relation(fields: [productId], references: [id])
  productVariant   ProductVariant? @relation(fields: [productVariantId], references: [id])

  @@index([orderId])
  @@map("order_items")
}

model Coupon {
  id            String             @id @default(cuid())
  tenantId      String
  code          String             @unique
  type          CouponType         @default(PERCENTAGE)
  value         Decimal
  minimumAmount Decimal?
  usageLimit    Int?
  usedCount     Int                @default(0)
  validFrom     DateTime?
  validUntil    DateTime?
  isActive      Boolean            @default(true)
  createdAt     DateTime           @default(now())
  redemptions   CouponRedemption[]
  tenant        Tenant             @relation(fields: [tenantId], references: [id])

  @@index([tenantId, code])
  @@index([isActive, validFrom, validUntil])
  @@map("coupons")
}

model CouponRedemption {
  id             String   @id @default(cuid())
  couponId       String
  orderId        String
  customerEmail  String
  discountAmount Decimal
  redeemedAt     DateTime @default(now())
  coupon         Coupon   @relation(fields: [couponId], references: [id])
  order          Order    @relation(fields: [orderId], references: [id])

  @@unique([couponId, orderId])
  @@map("coupon_redemptions")
}

model ShippingZone {
  id        String           @id @default(cuid())
  tenantId  String
  name      String
  countries String[]
  isActive  Boolean          @default(true)
  createdAt DateTime         @default(now())
  methods   ShippingMethod[]
  tenant    Tenant           @relation(fields: [tenantId], references: [id])

  @@map("shipping_zones")
}

model ShippingMethod {
  id            String       @id @default(cuid())
  zoneId        String
  name          String
  type          ShippingType @default(FLAT_RATE)
  price         Decimal
  minimumAmount Decimal?
  estimatedDays Int?
  isActive      Boolean      @default(true)
  createdAt     DateTime     @default(now())
  orders        Order[]
  zone          ShippingZone @relation(fields: [zoneId], references: [id])

  @@map("shipping_methods")
}

model TaxRate {
  id        String   @id @default(cuid())
  tenantId  String
  country   String
  state     String?
  rate      Decimal
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, country, state])
  @@map("tax_rates")
}

model PaymentMethod {
  id          String          @id @default(cuid())
  tenantId    String
  provider    PaymentProvider @default(HYPERPAY)
  name        String
  isActive    Boolean         @default(true)
  credentials Json?
  settings    Json?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  orders      Order[]
  tenant      Tenant          @relation(fields: [tenantId], references: [id])

  @@index([tenantId, provider])
  @@map("payment_methods")
}

model Transaction {
  id                String            @id @default(cuid())
  tenantId          String
  orderId           String?
  orderNumber       String?
  amount            Decimal // Total transaction amount
  platformFee       Decimal           @default(0) // Platform commission
  merchantEarnings  Decimal // Amount merchant receives (amount - platformFee)
  currency          String            @default("USD")
  status            TransactionStatus @default(PENDING)
  paymentProvider   PaymentProvider
  paymentMethodType String? // e.g., "credit_card", "debit_card", "wallet"
  transactionId     String? // External payment gateway transaction ID
  customerEmail     String?
  customerName      String?
  description       String?
  metadata          Json? // Additional payment details
  processedAt       DateTime?
  settledAt         DateTime? // When funds were settled to merchant
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  tenant            Tenant            @relation(fields: [tenantId], references: [id])
  order             Order?            @relation(fields: [orderId], references: [id])

  @@index([tenantId, status])
  @@index([orderId])
  @@index([customerEmail])
  @@index([createdAt])
  @@map("transactions")
}

model CustomDomain {
  id              String           @id @default(cuid())
  tenantId        String
  domain          String           @unique
  status          DomainStatus     @default(PENDING)
  sslStatus       SSLStatus        @default(PENDING)
  verifiedAt      DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  tenant          Tenant           @relation(fields: [tenantId], references: [id])
  sslCertificates SSLCertificate[]

  @@index([tenantId])
  @@index([domain])
  @@map("custom_domains")
}

model SSLCertificate {
  id          String       @id @default(cuid())
  domainId    String
  certificate String?
  privateKey  String?
  issuer      String?
  expiresAt   DateTime?
  autoRenew   Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  tenantId    String?
  domain      CustomDomain @relation(fields: [domainId], references: [id])
  Tenant      Tenant?      @relation(fields: [tenantId], references: [id])

  @@index([expiresAt])
  @@map("ssl_certificates")
}

model WebhookEndpoint {
  id                String            @id @default(cuid())
  tenantId          String
  url               String
  events            String[]
  secret            String
  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  webhookDeliveries WebhookDelivery[]
  tenant            Tenant            @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@map("webhook_endpoints")
}

model WebhookDelivery {
  id           String          @id @default(cuid())
  endpointId   String
  event        String
  payload      Json
  responseCode Int?
  responseBody String?
  attempts     Int             @default(1)
  deliveredAt  DateTime?
  createdAt    DateTime        @default(now())
  endpoint     WebhookEndpoint @relation(fields: [endpointId], references: [id])

  @@index([endpointId, event])
  @@index([createdAt])
  @@map("webhook_deliveries")
}

model Theme {
  id            String         @id @default(cuid())
  tenantId      String
  name          String
  description   String?
  version       String         @default("1.0.0")
  isActive      Boolean        @default(false)
  isInstalled   Boolean        @default(true)
  settings      Json?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  draftSettings Json?
  versions      ThemeVersion[]
  tenant        Tenant         @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@map("themes")
}

model ThemeVersion {
  id        String   @id @default(cuid())
  themeId   String
  version   String
  sourceUrl String?
  settings  Json?
  createdAt DateTime @default(now())
  theme     Theme    @relation(fields: [themeId], references: [id], onDelete: Cascade)

  @@unique([themeId, version])
  @@map("theme_versions")
}

model Plugin {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  description String?
  version     String
  isActive    Boolean  @default(false)
  settings    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@map("plugins")
}

model Page {
  id           String        @id @default(cuid())
  tenantId     String
  title        String
  slug         String
  content      Json?
  isPublished  Boolean       @default(false)
  seoTitle     String?
  seoDesc      String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  draftContent Json?
  history      PageHistory[]
  tenant       Tenant        @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@map("pages")
}

model PageHistory {
  id        String   @id @default(cuid())
  pageId    String
  content   Json
  version   Int      @default(1)
  createdAt DateTime @default(now())
  createdBy String?
  page      Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([pageId])
  @@map("page_history")
}

model Template {
  id          String   @id @default(cuid())
  name        String
  category    String
  description String?
  thumbnail   String?
  content     Json
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([isDefault])
  @@map("templates")
}

model SiteConfig {
  tenantId       String   @id
  header         Json
  footer         Json
  background     Json
  language       String   @default("en")
  theme          String   @default("light")
  paymentMethods String[]
  hyperpayConfig Json?
  tenant         Tenant   @relation(fields: [tenantId], references: [id])

  @@map("site_configs")
}

model User {
  id             String          @id @default(cuid())
  email          String          @unique
  password       String
  name           String?
  role           UserRole        @default(SHOP_OWNER)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  tenantId       String?
  avatar         String?
  recoveryId     String?         @unique // Secret recovery ID for account recovery
  tenant         Tenant?         @relation(fields: [tenantId], references: [id])
  sentMessages   ChatMessage[]   @relation("SentMessages")
  gifts          UserGift[]
  securityEvents SecurityEvent[]
  // Digital Cards Marketplace
  cardsPurchased    CardInventory[]       @relation("CardsSold")
  cardOrders        CardOrder[]           @relation("CardOrders")
  wallet            Wallet?
  topUpRequests     WalletTopUpRequest[]  @relation("TopUpRequests")
  processedTopUps   WalletTopUpRequest[]  @relation("ProcessedTopUps")
  bankAccounts      BankAccount[]         @relation("BankAccounts")
  favorites         MerchantFavorite[]    @relation("Favorites")
  supportTickets    SupportTicket[]       @relation("SupportTickets")
  assignedTickets   SupportTicket[]       @relation("AssignedTickets")
  ticketReplies     TicketReply[]         @relation("TicketReplies")
  importedBatches   CardBatch[]           @relation("ImportedBatches")
  // Merchant Dealer App
  merchant          Merchant?
  employee          Employee?

  @@index([tenantId])
  @@map("users")
}

model ActivityLog {
  id        String   @id @default(cuid())
  tenantId  String
  actorId   String
  targetId  String?
  action    String
  details   Json?
  createdAt DateTime @default(now())
  tenant    Tenant   @relation(fields: [tenantId], references: [id], name: "ActivityLogs")

  @@index([tenantId, createdAt])
  @@map("activity_logs")
}

model ChatMessage {
  id        String   @id @default(cuid())
  tenantId  String
  senderId  String
  content   String
  createdAt DateTime @default(now())
  tenant    Tenant   @relation(fields: [tenantId], references: [id], name: "ChatMessages")
  sender    User     @relation(fields: [senderId], references: [id], name: "SentMessages")

  @@index([tenantId, createdAt])
  @@map("chat_messages")
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum PlanType {
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum Status {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
  CANCELLED
}

enum ShippingStatus {
  UNFULFILLED
  PARTIALLY_FULFILLED
  FULFILLED
}

enum DomainStatus {
  PENDING
  ACTIVE
  VERIFICATION_FAILED
  SUSPENDED
}

enum SSLStatus {
  PENDING
  ACTIVE
  FAILED
  EXPIRED
}

enum CouponType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
}

enum ShippingType {
  FLAT_RATE
  FREE
  REAL_TIME
}

enum PaymentProvider {
  HYPERPAY
  STRIPE
  PAYPAL
  CASH_ON_DELIVERY
  NEOLEAP
}

enum UserRole {
  SUPER_ADMIN
  SHOP_OWNER
  STAFF
  CUSTOMER
}

enum CommissionType {
  PERCENTAGE
  FIXED
}

enum IntegrationType {
  ANALYTICS
  SHIPPING
  EMAIL
  SMS
  PAYMENT
  SOCIAL
  ACCOUNTING
  SUPPLIER
}

// Feature Flags - Control features per tenant or globally
model FeatureFlag {
  id        String   @id @default(cuid())
  tenantId  String?
  feature   String // e.g., "chat", "ai_assistant", "page_builder"
  enabled   Boolean  @default(true)
  config    Json? // Feature-specific configuration
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, feature])
  @@index([feature])
  @@map("feature_flags")
}

// Payment Plans - Installment payment configurations
model PaymentPlan {
  id             String   @id @default(cuid())
  name           String
  nameAr         String?
  description    String?
  installments   Int // Number of installments
  interestRate   Decimal  @default(0) // Interest rate percentage
  minAmount      Decimal? // Minimum order amount
  maxAmount      Decimal? // Maximum order amount
  isActive       Boolean  @default(true)
  allowedTenants String[] // Empty = all tenants
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("payment_plans")
}

// Platform Configuration - Global platform settings
model PlatformConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json
  description String?
  category    String // e.g., "payment", "features", "limits"
  isEditable  Boolean  @default(true)
  updatedAt   DateTime @updatedAt
  updatedBy   String?

  @@index([category])
  @@map("platform_configs")
}

// Platform Features - Global feature definitions and plan requirements
model PlatformFeature {
  id            String   @id @default(cuid())
  feature       String   @unique // key
  displayName   String
  displayNameAr String?
  description   String?
  category      String
  requiredPlan  PlanType @default(STARTER)
  isGlobal      Boolean  @default(true)
  isEnabled     Boolean  @default(true)
  config        Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("platform_features")
}

// User Gifts - Gifts and rewards for users/tenants
model UserGift {
  id          String     @id @default(cuid())
  userId      String?
  tenantId    String?
  giftType    GiftType
  giftValue   String
  giftDetails Json?
  status      GiftStatus @default(ACTIVE)
  expiresAt   DateTime?
  grantedBy   String
  grantedAt   DateTime   @default(now())
  message     String?

  user   User?   @relation(fields: [userId], references: [id])
  tenant Tenant? @relation(fields: [tenantId], references: [id])

  @@map("user_gifts")
}

// Subscription Plans - Plan configurations
model SubscriptionPlan {
  id            String   @id @default(cuid())
  code          String   @unique // e.g. STARTER, PROFESSIONAL
  name          String
  nameAr        String?
  description   String?
  descriptionAr String?
  price         Decimal
  currency      String   @default("SAR")
  billingCycle  String   @default("MONTHLY") // MONTHLY, YEARLY
  features      String[]
  featuresAr    String[]
  limits        Json? // { products: 100, staff: 2 }
  isActive      Boolean  @default(true)
  isPopular     Boolean  @default(false)
  sortOrder     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("subscription_plans")
}

enum GiftType {
  PLAN_UPGRADE
  FEATURE_ACCESS
  CREDIT
  EXTENSION
  TRIAL
}

enum GiftStatus {
  ACTIVE
  EXPIRED
  REVOKED
  USED
}

// Integrations - Third-party service integrations
model Integration {
  id          String          @id @default(cuid())
  tenantId    String?
  name        String
  type        IntegrationType
  provider    String // e.g., "google_analytics", "mailchimp", "twilio"
  credentials Json // Encrypted credentials
  settings    Json?
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, type])
  @@map("integrations")
}

// Partner - Business partners with commission structure
model Partner {
  id              String         @id @default(cuid())
  name            String
  nameAr          String?
  email           String         @unique
  phone           String?
  logo            String?        // Partner logo URL
  description     String?        @db.Text // Partner description
  descriptionAr   String?        @db.Text // Partner description in Arabic
  website         String?        // Partner website URL
  commissionType  CommissionType @default(PERCENTAGE)
  commissionValue Decimal
  isActive        Boolean        @default(true)
  allowedFeatures String[]
  settings        Json?
  aiScript        String?        @db.Text // Custom AI training script/context
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@map("partners")
}

// Audit Log - Track all master dashboard actions
model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  userRole   UserRole
  action     String // e.g., "TENANT_CREATED", "GATEWAY_ENABLED"
  resource   String // e.g., "Tenant", "PaymentGateway"
  resourceId String?
  changes    Json? // Before/after values
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@map("audit_logs")
}

// Supplier - For managing suppliers with discount rates
model Supplier {
  id                 String            @id @default(cuid())
  tenantId           String
  name               String
  nameAr             String?
  email              String?
  phone              String?
  contactPerson      String?
  address            String?
  discountRate       Decimal           @default(0) // Discount percentage
  isActive           Boolean           @default(true)
  notes              String?
  // API Configuration
  apiEndpoint        String?           // Supplier API endpoint URL
  apiKey             String?            // API authentication key (encrypted)
  apiConfig          Json?             // Additional API configuration (headers, auth type, etc.)
  autoPurchaseEnabled Boolean          @default(false) // Enable auto-purchase from this supplier
  priceCheckInterval  Int?              // Price check interval in minutes (default: 60)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  tenant             Tenant            @relation(fields: [tenantId], references: [id])
  products           ProductSupplier[]
  supplierPurchases  SupplierPurchase[]

  @@index([tenantId])
  @@index([isActive])
  @@map("suppliers")
}

// Brand - For managing product brands
model Brand {
  id                         String        @id @default(cuid())
  tenantId                   String
  name                       String
  nameAr                     String?
  code                       String?       // Brand code
  shortName                  String?
  brandType                  String?       // Brand type/category
  logo                       String?       // Brand logo URL
  image                      String?       // Brand banner image
  status                     String        @default("Active") // Active, Inactive
  rechargeUsdValue           Decimal?      @default(0)
  usdValueForCoins           Decimal?      @default(0)
  safetyStock                Decimal?      @default(0)
  leadTime                   Int?          @default(0) // Days
  reorderPoint               Decimal?      @default(0)
  averageConsumptionPerMonth Decimal?      @default(0)
  averageConsumptionPerDay   Decimal?      @default(0)
  abcAnalysis                String?       // A, B, C - High/Medium/Low Value
  odooCategoryId             String?       // Odoo integration ID
  sortOrder                  Int           @default(0) // Display order
  createdAt                  DateTime      @default(now())
  updatedAt                  DateTime      @updatedAt
  tenant                     Tenant        @relation(fields: [tenantId], references: [id])
  products                   Product[]
  cardProducts               CardProduct[] @relation("CardProductBrand")

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([code])
  @@map("brands")
}

// ProductSupplier - Many-to-many relationship between Product and Supplier
model ProductSupplier {
  id           String   @id @default(cuid())
  productId    String
  supplierId   String
  discountRate Decimal  @default(0) // Product-specific discount from this supplier
  isPrimary    Boolean  @default(false) // Primary supplier for this product
  supplierProductCode String? // Product code/ID in supplier's system
  lastPrice    Decimal? // Last fetched price from supplier
  lastPriceCheck DateTime? // When price was last checked
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  supplier     Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([productId, supplierId])
  @@index([productId])
  @@index([supplierId])
  @@map("product_suppliers")
}

// SupplierPurchase - Track purchases from suppliers and price changes
model SupplierPurchase {
  id              String   @id @default(cuid())
  tenantId        String
  productId       String
  supplierId      String
  quantity        Int      @default(1)
  unitPrice       Decimal  // Price per unit when purchased
  totalAmount     Decimal  // Total purchase amount
  status          String   @default("PENDING") // PENDING, COMPLETED, CANCELLED, REFUNDED
  purchaseDate    DateTime @default(now())
  cancelledAt     DateTime?
  refundedAt      DateTime?
  refundAmount    Decimal?
  reason          String?  // Reason for cancellation/refund
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  supplier        Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([productId])
  @@index([supplierId])
  @@index([status])
  @@map("supplier_purchases")
}

// Currency - Available currencies
model Currency {
  id           String   @id @default(cuid())
  tenantId     String
  code         String // ISO currency code (USD, SAR, EUR, etc.)
  name         String
  nameAr       String?
  symbol       String // $, SAR, €, etc.
  symbolAr     String? // Arabic symbol (ر.س, د.إ, etc.)
  exchangeRate Decimal  @default(1) // Exchange rate to base currency
  precision    Int      @default(2) // Decimal places for currency amounts
  isActive     Boolean  @default(true)
  isDefault    Boolean  @default(false) // Is this the default currency for the tenant
  sortOrder    Int      @default(0) // Display order
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  tenant       Tenant   @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([isActive])
  @@index([isDefault])
  @@map("currencies")
}

// CurrencySettings - Tenant currency configuration
model CurrencySettings {
  id              String    @id @default(cuid())
  tenantId        String    @unique
  baseCurrency    String    @default("SAR") // Base currency code
  autoUpdateRates Boolean   @default(false)
  lastUpdated     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  tenant          Tenant    @relation(fields: [tenantId], references: [id])

  @@map("currency_settings")
}

// Unit - Product units with costs
model Unit {
  id          String    @id @default(cuid())
  tenantId    String
  name        String
  nameAr      String?
  code        String // Unit code (e.g., "KG", "L", "PCS")
  symbol      String? // Unit symbol (e.g., "kg", "l", "pcs")
  cost        Decimal   @default(0) // Cost in base currency
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  products    Product[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([isActive])
  @@map("units")
}

model SecurityEvent {
  id          String            @id @default(cuid())
  type        SecurityEventType
  severity    SecuritySeverity
  userId      String?
  tenantId    String?
  ipAddress   String?
  userAgent   String?
  description String
  metadata    Json? // Changed from String to Json for easier access in core
  // Geolocation fields
  country     String?
  countryCode String?
  city        String?
  region      String?
  latitude    Float?
  longitude   Float?
  isp         String?
  isVpn       Boolean           @default(false)
  isProxy     Boolean           @default(false)
  // Device info fields
  os          String?
  browser     String?
  device      String?
  createdAt   DateTime          @default(now())
  tenant      Tenant?           @relation(fields: [tenantId], references: [id])
  user        User?             @relation(fields: [userId], references: [id])

  @@index([type, severity])
  @@index([createdAt])
  @@index([tenantId])
  @@index([userId])
  @@map("security_events")
}

enum SecurityEventType {
  SUCCESSFUL_LOGIN
  FAILED_LOGIN_ATTEMPT
  SUSPICIOUS_LOGIN
  BRUTE_FORCE_ATTEMPT
  FRAUD_ATTEMPT
  RATE_LIMIT_EXCEEDED
  UNUSUAL_ACTIVITY
  SECURITY_BREACH
  ACCOUNT_LOCKED
  PASSWORD_RESET_ATTEMPT
  INVALID_RESET_CODE
  INVALID_REFRESH_TOKEN
  DEVICE_FINGERPRINT
  VM_DETECTED
  HIGH_RISK_DEVICE
  MULTIPLE_ACCOUNTS_ON_DEVICE
}

enum SecuritySeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ==========================================
// DIGITAL CARDS MARKETPLACE MODELS
// ==========================================

// CardProduct - Digital card products (e.g., "Netflix 100 SAR", "PUBG UC 1000")
model CardProduct {
  id                String              @id @default(cuid())
  tenantId          String
  brandId           String?             // Reference to Brand
  categoryId        String?             // Reference to category
  name              String              // Product name
  nameAr            String?             // Arabic name
  description       String?             @db.Text
  descriptionAr     String?             @db.Text
  image             String?             // Product image URL
  productCode       String?             // External supplier product code
  denomination      Decimal             // Face value (100, 200, etc.)
  currency          String              @default("SAR") // Currency of denomination
  wholesalePrice    Decimal             // Price merchants pay
  retailPrice       Decimal             // Suggested retail price
  profitMargin      Decimal             @default(0) // Profit percentage
  taxRate           Decimal             @default(0.15) // Tax rate (15% VAT)
  isActive          Boolean             @default(true)
  isAvailable       Boolean             @default(true) // Has stock?
  stockCount        Int                 @default(0) // Current stock count
  minQuantity       Int                 @default(1) // Minimum order quantity
  maxQuantity       Int                 @default(100) // Maximum order quantity
  sortOrder         Int                 @default(0)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  tenant            Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  brand             Brand?              @relation("CardProductBrand", fields: [brandId], references: [id])
  category          Category?           @relation("CardProductCategory", fields: [categoryId], references: [id])
  inventory         CardInventory[]
  orderItems        CardOrderItem[]
  favorites         MerchantFavorite[]
  // Merchant Dealer App relations
  merchantCartItems     MerchantCartItem[]
  merchantOrderItems    MerchantOrderItem[]
  priceAlerts           PriceAlertSubscription[]
  priceHistory          ProductPriceHistory[]
  merchantFavoritesV2   MerchantFavoriteV2[]
  merchantOverrides     MerchantProductOverride[]

  @@unique([tenantId, productCode])
  @@index([tenantId])
  @@index([brandId])
  @@index([categoryId])
  @@index([isActive, isAvailable])
  @@map("card_products")
}

// CardInventory - Individual card codes in stock (imported from Excel)
model CardInventory {
  id              String              @id @default(cuid())
  tenantId        String
  productId       String              // Reference to CardProduct
  cardCode        String              // The actual card code/serial
  cardPin         String?             // PIN if applicable
  expiryDate      DateTime?           // Expiry date of the card
  batchId         String?             // Batch/import reference
  importedAt      DateTime            @default(now())
  status          CardStatus          @default(AVAILABLE)
  soldAt          DateTime?           // When it was sold
  soldToUserId    String?             // Who bought it
  orderId         String?             // Which order it was sold in
  
  tenant          Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product         CardProduct         @relation(fields: [productId], references: [id], onDelete: Cascade)
  soldToUser      User?               @relation("CardsSold", fields: [soldToUserId], references: [id])
  order           CardOrder?          @relation(fields: [orderId], references: [id])

  @@unique([tenantId, cardCode]) // Each card code is unique per tenant
  @@index([tenantId])
  @@index([productId])
  @@index([status])
  @@index([batchId])
  @@map("card_inventory")
}

enum CardStatus {
  AVAILABLE     // Ready to sell
  RESERVED      // Reserved during checkout
  SOLD          // Sold and delivered
  EXPIRED       // Expired card
  INVALID       // Invalid/defective card
  REFUNDED      // Refunded back to inventory
}

// CardOrder - Orders placed by merchants
model CardOrder {
  id                  String              @id @default(cuid())
  tenantId            String
  userId              String              // The merchant who placed the order
  orderNumber         String              // Human-readable order number
  status              CardOrderStatus     @default(PENDING)
  totalAmount         Decimal             // Total before tax
  taxAmount           Decimal             @default(0)
  totalWithTax        Decimal             // Total after tax
  currency            String              @default("SAR")
  paymentMethod       String              @default("WALLET") // WALLET, VISA, etc.
  paymentStatus       PaymentStatus       @default(PENDING)
  paidAt              DateTime?
  deliveredAt         DateTime?
  cancelledAt         DateTime?
  cancellationReason  String?
  notes               String?
  ipAddress           String?
  userAgent           String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  
  tenant              Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user                User                @relation("CardOrders", fields: [userId], references: [id])
  items               CardOrderItem[]
  cards               CardInventory[]     // The actual cards delivered
  transaction         WalletTransaction?  @relation("OrderTransaction")

  @@unique([tenantId, orderNumber])
  @@index([tenantId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("card_orders")
}

enum CardOrderStatus {
  PENDING           // Order created, awaiting payment
  PAID              // Payment received
  PROCESSING        // Preparing cards for delivery
  DELIVERED         // Cards delivered to merchant
  PARTIALLY_DELIVERED // Some cards delivered
  CANCELLED         // Order cancelled
  REFUNDED          // Order refunded
  FAILED            // Order failed
}

// CardOrderItem - Items in each order
model CardOrderItem {
  id              String          @id @default(cuid())
  orderId         String
  productId       String
  quantity        Int
  unitPrice       Decimal         // Price per card at time of order
  totalPrice      Decimal         // quantity * unitPrice
  taxAmount       Decimal         @default(0)
  totalWithTax    Decimal
  deliveredCount  Int             @default(0) // How many have been delivered
  
  order           CardOrder       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product         CardProduct     @relation(fields: [productId], references: [id])
  deliveries      CardDelivery[]

  @@index([orderId])
  @@index([productId])
  @@map("card_order_items")
}

// CardDelivery - Delivered card codes to merchants
model CardDelivery {
  id              String          @id @default(cuid())
  orderItemId     String
  cardCode        String          // The delivered card code
  cardPin         String?         // PIN if applicable
  deliveredAt     DateTime        @default(now())
  viewedAt        DateTime?       // When merchant first viewed the code
  downloadedAt    DateTime?       // When merchant downloaded
  
  orderItem       CardOrderItem   @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@index([orderItemId])
  @@map("card_deliveries")
}

// Wallet - Wallet for each user/merchant
model Wallet {
  id              String              @id @default(cuid())
  tenantId        String
  userId          String              @unique
  balance         Decimal             @default(0)
  currency        String              @default("SAR")
  isActive        Boolean             @default(true)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  tenant          Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions    WalletTransaction[]

  @@index([tenantId])
  @@index([userId])
  @@map("wallets")
}

// WalletTransaction - All wallet transactions
model WalletTransaction {
  id                  String                  @id @default(cuid())
  walletId            String
  type                WalletTransactionType
  amount              Decimal
  balanceBefore       Decimal
  balanceAfter        Decimal
  currency            String                  @default("SAR")
  description         String?
  descriptionAr       String?
  reference           String?                 // External reference (order ID, topup ID)
  status              TransactionStatus       @default(COMPLETED)
  orderId             String?                 @unique // Link to card order
  topUpRequestId      String?                 @unique // Link to top-up request
  createdAt           DateTime                @default(now())
  
  wallet              Wallet                  @relation(fields: [walletId], references: [id], onDelete: Cascade)
  order               CardOrder?              @relation("OrderTransaction", fields: [orderId], references: [id])
  topUpRequest        WalletTopUpRequest?     @relation("TopUpTransaction", fields: [topUpRequestId], references: [id])

  @@index([walletId])
  @@index([type])
  @@index([createdAt])
  @@map("wallet_transactions")
}

enum WalletTransactionType {
  TOPUP             // Wallet top-up
  PURCHASE          // Card purchase (debit)
  REFUND            // Refund from cancelled order
  BONUS             // Bonus/reward credit
  ADJUSTMENT        // Manual adjustment by admin
  WITHDRAWAL        // Withdrawal request
}

// TransactionStatus already exists in the schema - reusing it

// WalletTopUpRequest - Pending top-up requests
model WalletTopUpRequest {
  id                  String              @id @default(cuid())
  tenantId            String
  userId              String
  amount              Decimal
  currency            String              @default("SAR")
  paymentMethod       TopUpPaymentMethod
  bankId              String?             // Bank used for transfer
  senderAccountId     String?             // Sender's bank account
  senderName          String?             // Name of sender
  transferReference   String?             // Bank transfer reference
  receiptImage        String?             // Receipt image URL
  notes               String?
  status              TopUpStatus         @default(PENDING)
  processedAt         DateTime?
  processedByUserId   String?             // Admin who processed
  rejectionReason     String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  
  tenant              Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user                User                @relation("TopUpRequests", fields: [userId], references: [id])
  bank                Bank?               @relation(fields: [bankId], references: [id])
  senderAccount       BankAccount?        @relation(fields: [senderAccountId], references: [id])
  processedBy         User?               @relation("ProcessedTopUps", fields: [processedByUserId], references: [id])
  transaction         WalletTransaction?  @relation("TopUpTransaction")

  @@index([tenantId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("wallet_topup_requests")
}

enum TopUpPaymentMethod {
  BANK_TRANSFER
  VISA
  MASTERCARD
  MADA
  APPLE_PAY
  STC_PAY
}

enum TopUpStatus {
  PENDING           // Awaiting verification
  APPROVED          // Approved and credited
  REJECTED          // Rejected by admin
  CANCELLED         // Cancelled by user
}

// Bank - Banks for wallet top-ups
model Bank {
  id              String          @id @default(cuid())
  tenantId        String
  name            String          // Bank name (e.g., "Al Rajhi Bank")
  nameAr          String?         // Arabic name (e.g., "مصرف الراجحي")
  code            String          // Bank code (e.g., "RJHI")
  logo            String?         // Bank logo URL
  accountName     String          // Receiver account name
  accountNumber   String          // Receiver account number
  iban            String          // IBAN
  swiftCode       String?         // SWIFT code
  isActive        Boolean         @default(true)
  sortOrder       Int             @default(0)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  topUpRequests   WalletTopUpRequest[]
  paymentIntents  PaymentIntent[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([isActive])
  @@map("banks")
}

// BankAccount - Merchant's bank accounts for transfers
model BankAccount {
  id              String          @id @default(cuid())
  userId          String
  bankName        String          // Name of the bank
  bankCode        String?         // Bank code
  accountName     String          // Account holder name
  accountNumber   String
  iban            String?
  isDefault       Boolean         @default(false)
  isVerified      Boolean         @default(false)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  user            User            @relation("BankAccounts", fields: [userId], references: [id], onDelete: Cascade)
  topUpRequests   WalletTopUpRequest[]

  @@index([userId])
  @@map("bank_accounts")
}

// MerchantFavorite - Favorite cards for quick access
model MerchantFavorite {
  id              String          @id @default(cuid())
  userId          String
  productId       String          // CardProduct reference
  addedAt         DateTime        @default(now())
  
  user            User            @relation("Favorites", fields: [userId], references: [id], onDelete: Cascade)
  product         CardProduct     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@map("merchant_favorites")
}

// SupportTicket - Support tickets/complaints
model SupportTicket {
  id              String              @id @default(cuid())
  tenantId        String
  userId          String
  ticketNumber    String              // Human-readable ticket number
  title           String
  description     String              @db.Text
  orderId         String?             // Related order if any
  status          TicketStatus        @default(OPEN)
  priority        TicketPriority      @default(MEDIUM)
  assignedToId    String?             // Assigned staff member
  resolvedAt      DateTime?
  closedAt        DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  tenant          Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user            User                @relation("SupportTickets", fields: [userId], references: [id])
  assignedTo      User?               @relation("AssignedTickets", fields: [assignedToId], references: [id])
  replies         TicketReply[]

  @@unique([tenantId, ticketNumber])
  @@index([tenantId])
  @@index([userId])
  @@index([status])
  @@map("support_tickets")
}

model TicketReply {
  id              String          @id @default(cuid())
  ticketId        String
  userId          String
  message         String          @db.Text
  isStaffReply    Boolean         @default(false)
  attachments     String[]        // Array of attachment URLs
  createdAt       DateTime        @default(now())
  
  ticket          SupportTicket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user            User            @relation("TicketReplies", fields: [userId], references: [id])

  @@index([ticketId])
  @@map("ticket_replies")
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_CUSTOMER
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// CardBatch - Track imported batches of cards
model CardBatch {
  id              String          @id @default(cuid())
  tenantId        String
  productId       String          // Which product these cards are for
  batchNumber     String          // Batch identifier
  fileName        String          // Original file name
  totalCards      Int             // Total cards in batch
  validCards      Int             // Successfully imported
  invalidCards    Int             // Failed to import
  importedAt      DateTime        @default(now())
  importedById    String          // Who imported
  notes           String?
  
  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  importedBy      User            @relation("ImportedBatches", fields: [importedById], references: [id])

  @@index([tenantId])
  @@index([productId])
  @@map("card_batches")
}

// ==========================================
// MERCHANT DEALER APP MODELS
// ==========================================

// Merchant - Primary tenant/account owner for dealer app
model Merchant {
  id                    String                @id @default(cuid())
  tenantId              String
  userId                String                @unique // Link to User account
  status                MerchantStatus        @default(ACTIVE)
  businessName          String
  businessNameAr        String?
  phone                 String?
  email                 String?
  countryCode           String                @default("SA")
  defaultCurrency       String                @default("SAR")
  timezone              String                @default("Asia/Riyadh")
  settings              Json?                 // Merchant-specific settings
  lowBalanceThreshold   Decimal               @default(100) // For low wallet alerts
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  tenant                Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user                  User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  employees             Employee[]
  players               Player[]
  merchantCarts         MerchantCart[]
  merchantOrders        MerchantOrder[]
  invoices              Invoice[]
  merchantNotifications MerchantNotification[]
  priceAlerts           PriceAlertSubscription[]
  promotionProgress     MerchantPromotionProgress[]
  merchantFavorites     MerchantFavoriteV2[]
  merchantAuditLogs     MerchantAuditLog[]
  merchantSessions      MerchantSession[]

  @@unique([tenantId, userId])
  @@index([tenantId])
  @@index([status])
  @@map("merchants")
}

enum MerchantStatus {
  ACTIVE
  SUSPENDED
  PENDING
}

// Employee - Sub-account under a merchant
model Employee {
  id              String          @id @default(cuid())
  merchantId      String
  userId          String?         @unique // Link to User if they have login
  name            String
  username        String          // Login username
  passwordHash    String?         // For standalone employee login
  phone           String?
  status          EmployeeStatus  @default(ACTIVE)
  permissions     Json            // Permission flags as JSONB
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  merchant        Merchant        @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  user            User?           @relation(fields: [userId], references: [id])
  carts           MerchantCart[]
  orders          MerchantOrder[]
  auditLogs       MerchantAuditLog[] @relation("EmployeeAuditLogs")
  sessions        MerchantSession[]

  @@unique([merchantId, username])
  @@index([merchantId])
  @@index([status])
  @@map("employees")
}

enum EmployeeStatus {
  ACTIVE
  DISABLED
}

// Player - Merchant-saved customer profile
model Player {
  id              String              @id @default(cuid())
  merchantId      String
  name            String
  phone           String?
  notes           String?             @db.Text
  isFavorite      Boolean             @default(false)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  merchant        Merchant            @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  gameAccounts    PlayerGameAccount[]
  orders          MerchantOrder[]
  favorites       MerchantFavoriteV2[]

  @@index([merchantId])
  @@index([merchantId, name])
  @@index([merchantId, phone])
  @@map("players")
}

// PlayerGameAccount - Game accounts linked to a player
model PlayerGameAccount {
  id                  String          @id @default(cuid())
  playerId            String
  gameKey             String          // Game identifier (e.g., "pubg", "freefire")
  accountIdentifier   String          // Game user ID/account
  label               String?         // e.g., "Main account"
  createdAt           DateTime        @default(now())

  player              Player          @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, gameKey, accountIdentifier])
  @@index([playerId])
  @@map("player_game_accounts")
}

// MerchantCart - Server-side cart for merchant/employee
model MerchantCart {
  id              String              @id @default(cuid())
  merchantId      String
  employeeId      String?             // Optional employee scope
  currency        String              @default("SAR")
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  merchant        Merchant            @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  employee        Employee?           @relation(fields: [employeeId], references: [id])
  items           MerchantCartItem[]

  @@unique([merchantId, employeeId])
  @@index([merchantId])
  @@map("merchant_carts")
}

// MerchantCartItem - Items in merchant cart
model MerchantCartItem {
  id                  String          @id @default(cuid())
  cartId              String
  productId           String
  quantity            Int             @default(1)
  unitPriceSnapshot   Decimal?        // Optional snapshot at add time
  metadata            Json?           // Player account info, etc.
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  cart                MerchantCart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product             CardProduct     @relation(fields: [productId], references: [id])

  @@unique([cartId, productId])
  @@index([cartId])
  @@map("merchant_cart_items")
}

// MerchantOrder - Orders placed by merchants
model MerchantOrder {
  id                  String              @id @default(cuid())
  merchantId          String
  employeeId          String?             // Who created the order
  playerId            String?             // Optional player link
  orderNumber         String              // Human-readable
  source              OrderSource         @default(CART)
  originalOrderId     String?             // For reorders
  status              MerchantOrderStatus @default(PENDING)
  paymentMethod       PaymentMethod2      @default(WALLET)
  paymentStatus       MerchantPaymentStatus @default(UNPAID)
  currency            String              @default("SAR")
  subtotal            Decimal             @default(0)
  discountTotal       Decimal             @default(0)
  feesTotal           Decimal             @default(0)
  taxTotal            Decimal             @default(0)
  total               Decimal             @default(0)
  profitTotal         Decimal             @default(0) // Computed profit snapshot
  idempotencyKey      String?             // For deduplication
  clientReference     String?             // Optional client ref
  notes               String?             @db.Text
  ipAddress           String?
  userAgent           String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  submittedAt         DateTime?
  completedAt         DateTime?
  cancelledAt         DateTime?

  merchant            Merchant            @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  employee            Employee?           @relation(fields: [employeeId], references: [id])
  player              Player?             @relation(fields: [playerId], references: [id])
  originalOrder       MerchantOrder?      @relation("ReorderRef", fields: [originalOrderId], references: [id])
  reorders            MerchantOrder[]     @relation("ReorderRef")
  items               MerchantOrderItem[]
  events              MerchantOrderEvent[]
  paymentIntents      PaymentIntent[]
  invoice             Invoice?

  @@unique([merchantId, orderNumber])
  @@unique([merchantId, idempotencyKey])
  @@index([merchantId, createdAt])
  @@index([merchantId, status])
  @@index([merchantId, playerId])
  @@index([originalOrderId])
  @@map("merchant_orders")
}

enum OrderSource {
  CART
  QUICK_RECHARGE
  REORDER
  MANUAL
}

enum MerchantOrderStatus {
  DRAFT
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum PaymentMethod2 {
  WALLET
  BANK_TRANSFER
  MIXED
  EXTERNAL_GATEWAY
}

enum MerchantPaymentStatus {
  UNPAID
  PENDING
  PAID
  REFUNDED
  PARTIALLY_REFUNDED
}

// MerchantOrderItem - Items in merchant order
model MerchantOrderItem {
  id                      String          @id @default(cuid())
  orderId                 String
  productId               String
  productNameSnapshotEn   String
  productNameSnapshotAr   String?
  quantity                Int
  unitPrice               Decimal
  unitCost                Decimal
  lineSubtotal            Decimal
  lineDiscount            Decimal         @default(0)
  lineTotal               Decimal
  lineProfit              Decimal         @default(0)
  metadata                Json?           // Game account id, etc.

  order                   MerchantOrder   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product                 CardProduct     @relation(fields: [productId], references: [id])
  deliveries              MerchantOrderDelivery[]

  @@index([orderId])
  @@index([productId])
  @@map("merchant_order_items")
}

// MerchantOrderDelivery - Delivered codes for merchant orders
model MerchantOrderDelivery {
  id              String              @id @default(cuid())
  orderItemId     String
  cardCode        String
  cardPin         String?
  deliveredAt     DateTime            @default(now())
  viewedAt        DateTime?
  downloadedAt    DateTime?

  orderItem       MerchantOrderItem   @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@index([orderItemId])
  @@map("merchant_order_deliveries")
}

// MerchantOrderEvent - Order status history/events
model MerchantOrderEvent {
  id              String              @id @default(cuid())
  orderId         String
  type            OrderEventType
  fromStatus      String?
  toStatus        String?
  message         String?             @db.Text
  actorType       ActorType
  actorUserId     String?             // Reference to User id
  createdAt       DateTime            @default(now())

  order           MerchantOrder       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId, createdAt])
  @@map("merchant_order_events")
}

enum OrderEventType {
  CREATED
  SUBMITTED
  STATUS_CHANGED
  PAYMENT_CHANGED
  PROVIDER_UPDATE
  NOTE
}

enum ActorType {
  SYSTEM
  MERCHANT
  EMPLOYEE
  ADMIN
}

// PaymentIntent - For bank transfer / external payments
model PaymentIntent {
  id                      String              @id @default(cuid())
  merchantId              String
  orderId                 String
  method                  PaymentIntentMethod
  status                  PaymentIntentStatus @default(REQUIRES_ACTION)
  amount                  Decimal
  currency                String              @default("SAR")
  bankAccountId           String?             // Platform bank to transfer to
  proofAttachmentUrl      String?
  reviewedByAdminUserId   String?
  reviewNote              String?             @db.Text
  expiresAt               DateTime?
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt

  order                   MerchantOrder       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  bankAccount             Bank?               @relation(fields: [bankAccountId], references: [id])

  @@index([orderId])
  @@index([status, createdAt])
  @@map("payment_intents")
}

enum PaymentIntentMethod {
  BANK_TRANSFER
  GATEWAY
}

enum PaymentIntentStatus {
  REQUIRES_ACTION
  PENDING_REVIEW
  APPROVED
  REJECTED
  CANCELLED
  EXPIRED
}

// Invoice - Structured invoice/receipt record
model Invoice {
  id                  String          @id @default(cuid())
  merchantId          String
  orderId             String          @unique
  invoiceNumber       String          // Human-friendly number
  status              InvoiceStatus   @default(ISSUED)
  currency            String          @default("SAR")
  issuedAt            DateTime        @default(now())
  merchantSnapshot    Json            // Snapshot of merchant info
  buyerSnapshot       Json?           // Snapshot of player info
  itemsSnapshot       Json            // Snapshot of order items
  totalsSnapshot      Json            // Subtotal/discount/fees/total
  paymentSnapshot     Json?           // Payment method/status
  createdAt           DateTime        @default(now())

  merchant            Merchant        @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  order               MerchantOrder   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([merchantId, invoiceNumber])
  @@index([merchantId, issuedAt])
  @@map("invoices")
}

enum InvoiceStatus {
  ISSUED
  VOIDED
  REFUNDED
}

// Promotion - Platform promotions for merchants
model Promotion {
  id              String              @id @default(cuid())
  tenantId        String
  titleEn         String
  titleAr         String?
  descriptionEn   String?             @db.Text
  descriptionAr   String?             @db.Text
  type            PromotionType
  status          PromotionStatus     @default(DRAFT)
  startAt         DateTime
  endAt           DateTime
  conditions      Json                // min_orders, product_ids, min_volume, etc.
  benefit         Json                // discount %, cashback fixed, etc.
  imageUrl        String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  tenant          Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  progress        MerchantPromotionProgress[]

  @@index([tenantId])
  @@index([status, startAt, endAt])
  @@map("promotions")
}

enum PromotionType {
  CASHBACK
  DISCOUNT
  VOLUME_BASED
  TIERED
  PRICE_OVERRIDE
}

enum PromotionStatus {
  DRAFT
  ACTIVE
  SCHEDULED
  EXPIRED
  DISABLED
}

// MerchantPromotionProgress - Track merchant progress on promotions
model MerchantPromotionProgress {
  id              String          @id @default(cuid())
  merchantId      String
  promotionId     String
  progress        Json            // e.g., { orders_count: 73, volume: 5000 }
  isCompleted     Boolean         @default(false)
  completedAt     DateTime?
  rewardClaimed   Boolean         @default(false)
  updatedAt       DateTime        @updatedAt

  merchant        Merchant        @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  promotion       Promotion       @relation(fields: [promotionId], references: [id], onDelete: Cascade)

  @@unique([merchantId, promotionId])
  @@index([promotionId])
  @@map("merchant_promotion_progress")
}

// PriceAlertSubscription - Price alert subscriptions for merchants
model PriceAlertSubscription {
  id              String          @id @default(cuid())
  merchantId      String
  productId       String
  alertType       PriceAlertType
  isActive        Boolean         @default(true)
  lastNotifiedAt  DateTime?
  lastNotifiedPrice Decimal?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  merchant        Merchant        @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  product         CardProduct     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([merchantId, productId, alertType])
  @@index([productId, isActive])
  @@map("price_alert_subscriptions")
}

enum PriceAlertType {
  ANY_CHANGE
  DROP_ONLY
  RISE_ONLY
}

// ProductPriceHistory - Track product price changes
model ProductPriceHistory {
  id              String          @id @default(cuid())
  productId       String
  currency        String          @default("SAR")
  oldPrice        Decimal
  newPrice        Decimal
  changedAt       DateTime        @default(now())
  changedByUserId String?
  reason          String?

  product         CardProduct     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, changedAt])
  @@map("product_price_history")
}

// MerchantNotification - Notifications for merchants
model MerchantNotification {
  id              String                  @id @default(cuid())
  merchantId      String
  type            MerchantNotificationType
  titleEn         String
  titleAr         String?
  bodyEn          String                  @db.Text
  bodyAr          String?                 @db.Text
  data            Json?                   // order_id, product_id, etc.
  readAt          DateTime?
  createdAt       DateTime                @default(now())

  merchant        Merchant                @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([merchantId, createdAt])
  @@index([merchantId, readAt])
  @@map("merchant_notifications")
}

enum MerchantNotificationType {
  ORDER_STATUS
  PRICE_ALERT
  PROMOTION
  LOW_WALLET
  SUPPORT_UPDATE
  SYSTEM
}

// MerchantFavoriteV2 - Unified favorites for merchants (products and players)
model MerchantFavoriteV2 {
  id              String          @id @default(cuid())
  merchantId      String
  type            FavoriteType
  productId       String?         // Reference when type = PRODUCT
  playerId        String?         // Reference when type = PLAYER
  createdAt       DateTime        @default(now())

  merchant        Merchant        @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  product         CardProduct?    @relation(fields: [productId], references: [id], onDelete: Cascade)
  player          Player?         @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([merchantId, type, productId])
  @@unique([merchantId, type, playerId])
  @@index([merchantId, type])
  @@map("merchant_favorites_v2")
}

enum FavoriteType {
  PRODUCT
  PLAYER
}

// MerchantAuditLog - Audit logs for merchant actions
model MerchantAuditLog {
  id              String          @id @default(cuid())
  merchantId      String
  actorUserId     String?         // User who performed action
  actorEmployeeId String?         // Employee who performed action
  actorType       ActorType
  action          String          // e.g., "order.create", "report.view"
  entityType      String?
  entityId        String?
  ipAddress       String?
  userAgent       String?
  metadata        Json?
  createdAt       DateTime        @default(now())

  merchant        Merchant        @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  employee        Employee?       @relation("EmployeeAuditLogs", fields: [actorEmployeeId], references: [id])

  @@index([merchantId, createdAt])
  @@index([actorUserId, createdAt])
  @@index([action, createdAt])
  @@map("merchant_audit_logs")
}

// MerchantSession - Track merchant/employee sessions
model MerchantSession {
  id                  String          @id @default(cuid())
  merchantId          String
  employeeId          String?         // If employee session
  userId              String          // User account linked
  refreshTokenHash    String?         @db.VarChar(512)
  deviceId            String?         // Client-generated stable id
  deviceName          String?
  platform            String?         // ios/android/web
  ipAddress           String?
  userAgent           String?
  isTrusted           Boolean         @default(false)
  createdAt           DateTime        @default(now())
  lastSeenAt          DateTime        @default(now())
  revokedAt           DateTime?

  merchant            Merchant        @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  employee            Employee?       @relation(fields: [employeeId], references: [id])

  @@index([merchantId, revokedAt])
  @@index([userId, createdAt])
  @@map("merchant_sessions")
}

// MerchantProductOverride - Custom pricing per merchant
model MerchantProductOverride {
  id              String          @id @default(cuid())
  merchantId      String
  productId       String
  isEnabled       Boolean         @default(true)
  customPrice     Decimal?
  customCost      Decimal?
  updatedAt       DateTime        @updatedAt

  product         CardProduct     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([merchantId, productId])
  @@index([merchantId])
  @@map("merchant_product_overrides")
}

// API Keys - For authenticating API requests
model ApiKey {
  id          String    @id @default(cuid())
  name        String    // e.g., "Saeaa Website", "Edara Mobile App", "Asus App"
  apiKey      String    // Prefix for lookup (not unique since we store prefix)
  apiKeyHash  String    // bcrypt hash of the full API key
  tenantId    String
  isActive    Boolean   @default(true)
  lastUsedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([apiKey])
  @@map("api_keys")
}
